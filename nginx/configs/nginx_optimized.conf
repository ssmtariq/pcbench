# ========= nginx_optimized.conf =========

# Use all cores on xl170; better cache warmth per worker
worker_processes auto;

events {
    use epoll;
    worker_connections 4096;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    # Keep access_log commented like your current file (no change).
    # access_log  logs/access.log  main;

    # I/O path & TCP behavior
    sendfile        on;      # zero-copy from page cache
    tcp_nopush      on;      # coalesce packets with sendfile
    tcp_nodelay     on;      # avoid Nagle stalls on keep-alive

    # Keep-alives (general-purpose, not workload-specific)
    keepalive_timeout   30s;
    keepalive_requests  1000;

    # Right-size header buffers to reduce per-request cache footprint
    client_header_buffer_size   4k;
    large_client_header_buffers 4 8k;

    # Remove thread-pool AIO and direct I/O (mutex/cross-core churn)
    aio off;
    # aio_write off;           # implied when aio is off
    # directio off;            # rely on Linux page cache

    # File metadata/FD cache (moderate, actually used)
    open_file_cache          max=10000 inactive=60s;
    open_file_cache_valid    30s;
    open_file_cache_min_uses 1;
    open_file_cache_errors   off;

    server {
        listen 8080 reuseport;
        server_name localhost;

        location / {
            root   html;
            index  index.html index.htm;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html { root html; }
    }

    # Keep sensible defaults; drop oversized pools/buffers and legacy tweaks.
    server_tokens off;
}
# ========= end =========
